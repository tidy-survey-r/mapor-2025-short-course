---
title: "Modeling"
format: revealjs
---

```{r}
#| label: setup-modeling
#| message: false
library(tidyverse)
library(survey)
library(srvyr)
library(srvyrexploR)
anes_des <- anes_2024 %>%
  filter(InterviewMode_Post != "3. Paper (PAPI)") %>% 
  mutate(Weight = V240108b / sum(V240108b) * 232449541) %>%
  as_survey_design(
    weights = Weight,
    strata = V240108d,
    ids = V240108c,
    nest = TRUE
  )
```

## Introduction

::: incremental

* Modeling investigates the relationship between a single dependent variable and one or more independent variables.
* **Logistic regression** is a specific case of the generalized linear model (GLM).
* Logistic regression is used to model binary outcomes, such as whether or not someone voted.

:::

## Introduction

Assumptions in logistic regression using survey data include:

* The outcome variable has two levels
* There is a linear relationship between the independent variables and the log odds (the equation for the logit function)
* The residuals are homoscedastic; that is, the error term is the same across all values of independent variables

## `svyglm`: syntax

```{.r code-line-numbers="|1|2,8|3|4|5|6|7"}
des_obj %>%
  svyglm(
    formula = outcomevar ~ x1 + x2 + x3,
    design = .,
    na.action = na.omit,
    df.resid = NULL,
    family = quasibinomial
  )
```

## `svyglm`: example

Model whether a person usually trusts the government based on who they voted for in 2024[^1]:

. . .

1. Create a binary trust variable by grouping ‘Always’ and ‘Most of the time’ into one category, and all remaining responses into the other.

```{r}
#| echo: true
anes_des_der <- anes_des %>%
  mutate(TrustGovernmentUsually = case_when(
    is.na(TrustGovernment) ~ NA,
    TRUE ~ TrustGovernment %in% c("1. Always", "2. Most of the time")
  ))
```

[^1]: Harris, Trump, or Other

## `svyglm`: example

2. Summarize the data.

```{r}
#| echo: true
#| code-line-numbers: "|3|4-10"
anes_des_summary <-
  anes_des_der %>%
  group_by(VotedPres2024_selection) %>%
  summarize(pct_trust = survey_mean(
    TrustGovernmentUsually,
    na.rm = TRUE,
    proportion = TRUE,
    vartype = "ci"),
    .groups = "drop"
    ) %>%
  filter(complete.cases(.))
```

## `svyglm`: example

3. Plot the summary of the data.

```{r}
#| dpi: 300
anes_des_summary %>%
  ggplot(aes(
    x = VotedPres2024_selection, y = pct_trust,
    fill = VotedPres2024_selection
  )) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = pct_trust_low, ymax = pct_trust_upp),
    width = .2
  ) +
  scale_fill_manual(values = c("#0b3954", "#bfd7ea", "#8d6b94")) +
  xlab("Election choice (2020)") +
  ylab("Usually trust the government") +
  scale_y_continuous(labels = scales::percent) +
  guides(fill = "none") +
  theme_minimal()
```

## `svyglm`: example

4. Verify by fitting the model.

```{r}
#| output: slide
#| echo: true
#| code-line-numbers: "|2,6|3|4|5"
logistic_trust_vote <- anes_des_der %>%
  svyglm(
    design = .,
    formula = TrustGovernmentUsually ~ VotedPres2024_selection,
    family = quasibinomial
  )
```

## `svyglm`: example

4. Verify by fitting the model.

```{r}
#| echo: true
#| code-line-numbers: "|2,5|3,6|1,7,8"
library(gt)
library(broom)
library(prettyunits)

tidy(logistic_trust_vote) %>%
  mutate(p.value = pretty_p_value(p.value)) %>%
  gt() %>%
  fmt_number()
```

## `svyglm`: example

Result:

```{r}
tidy(logistic_trust_vote) %>%
  mutate(p.value = pretty_p_value(p.value)) %>%
  gt() %>%
  fmt_number()
```

1. Estimated coefficients (`estimate`)
2. Estimated standard errors of the coefficients (`std.error`)
3. p-value for each coefficient

## `svyglm`: example

Result:

```{r}
tidy(logistic_trust_vote) %>%
  mutate(p.value = pretty_p_value(p.value)) %>%
  gt() %>%
  fmt_number()
```

Compared with Harris voters, Trump voters show lower levels of trust in the government.

. . .

The coefficient of **-1.24** represents the increase in the log odds of usually trusting the government.

## `svyglm`: example

To talk about odds rather than log odds, we can exponentiate the coefficients.

```{r}
#| code-line-numbers: "|1"
#| echo: true
tidy(logistic_trust_vote, exponentiate = TRUE) %>%
  select(term, estimate) %>%
  gt() %>%
  fmt_number()
```

## `svyglm`: example

Result:

```{r}
#| code-line-numbers: "|1"
tidy(logistic_trust_vote, exponentiate = TRUE) %>%
  select(term, estimate) %>%
  gt() %>%
  fmt_number()
```

The odds that a Trump voter usually trusts the government are about **26%** of the odds for a Harris voter, who serves as the reference group.

## Interaction effects

Next, examine the interaction between early voting and income group in the model.

1. Subset to 2024 voters and create an indicator for Harris voters.

```{r}
anes_des_ind <- anes_des %>%
  filter(!is.na(VotedPres2024_selection)) %>%
  mutate(VoteHarris = case_when(
    VotedPres2024_selection == "1. Kamala Harris" ~ 1,
    TRUE ~ 0
  ))
```

## Interaction effects

2. Let’s look at the main effects of income grouping and early voting behavior.

```{r}
#| echo: true
log_harris_main <- anes_des_ind %>%
  mutate(
    EarlyVote2024 = fct_relevel(EarlyVote2024, "2. Have not voted", after = 0)
  ) %>%
  svyglm(
    design = .,
    formula = VoteHarris ~ EarlyVote2024 + Income7,
    family = quasibinomial
  )
```

## Interaction effects

Results:

```{r}
tidy(log_harris_main) %>%
  mutate(p.value = pretty_p_value(p.value)) %>%
  gt() %>%
  fmt_number()
```

This indicates that people with incomes of \$125,000 or more were more likely to vote for Harris in the 2024 election compared to people with incomes of $20,000 or less (reference level).

. . .

Early voting behavior was not significant.

## Interaction effects

To find the interaction between income and early voting behavior:

```{r}
#| echo: true
#| code-line-numbers: "|7"
log_harris_int <- anes_des_ind %>%
  mutate(
    EarlyVote2024 = fct_relevel(EarlyVote2024, "2. Have not voted", after = 0)
  ) %>%
  svyglm(
    design = .,
    formula = VoteHarris ~ (EarlyVote2024 + Income7)^2,
    family = quasibinomial
  )
```

## Interaction effects

Results:

```{r}
tidy(log_harris_int) %>%
  mutate(p.value = pretty_p_value(p.value)) %>%
  gt() %>%
  fmt_number()
```

None of the interactions were significant!
